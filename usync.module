<?php
/**
 * @file
 * ÂµSync module.
 */

use USync\AST\Node;
use USync\Parsing\PathDiscovery;
use USync\Parsing\YamlParser;
use USync\Runner;

use Symfony\Component\Yaml\Yaml;
use USync\Context;
use USync\USync;

/**
 * Load compatibility layer with other modules.
 */
require_once __DIR__ . '/usync.compat.inc';

/**
 * Implements hook_init().
 */
function usync_init() {
  // usync_import_yaml(DRUPAL_ROOT . '/' . drupal_get_path('module', 'usync') . '/sample/sample.yml');
  $discovery = new PathDiscovery();
  usync($discovery->discover(__DIR__ . '/sample/reallife', new YamlParser()));
}

/**
 * Do sync.
 *
 * @param \USync\Node $graph
 *   System configuration.
 */
function usync(Node $graph) {
  $tx = null;

  try {
    $tx = db_transaction();

    $context = new Context($graph);
    $runner = new Runner($context);
    $runner->run($context->getGraph(), $context);

    unset($tx); // Explicit commit.

  } catch (\Exception $e) {
    if ($tx) {
      try {
        $tx->rollback();
      } catch (Exception $e2) {}
    }

    drupal_set_message($e->getMessage(), 'error');
    return false;
  }

  return true;
}
